# PL-Disagg out-of-tree MLIR

## Building

Has integrated into `cgeist` building process

You may add 
1. mlir bin path: `{root}/llvm-project/build/bin`
2. polygeist and disagg bin path: `${root}/build/bin`

to PATH

## Using
The driver logic is in `standalone-pg`, check the available pass-pipeline in the output of
```sh
standalone-pg -help
```

## Workflow
1. The demonstration uses `test.c` in the `origin` dirc
```sh
cd tools/disagg/origin
```

2. Generate basic mlir
```sh
# ! may contain polygeist dialect if the program is complex
cgeist -v -S -O0 test.c -o out/base.mlir 
# or pass disin profile to add `remote_target` attribute to target malloc
cgeist -v -S -O0 test.c -disin="path/to/parsed-prof" -o out/base.mlir
```

3. Apply disaggregation conversion pass
  > current conversion does not consider target, it will convert every
  > - `memref.alloc`
  > - `llvm.call malloc`
  > - `fun.func`, `func.return`, `func.call` that involves `llvm.ptr` or `memref` 
```sh
# example: convert llvm.call and func malloc to remote
standalone-pg -pass-pipeline="convert-llvm-to-remote,convert-builtin-func-to-remote" out/base.mlir -o out/base_remote.mlir
```

Check the type (func signature, call convention) and type-conversion generated by the current logic.