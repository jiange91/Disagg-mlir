# change cache cfg
at /users/Zijian/new_rt/apps/dataframe/new_app/internal.cc
change line 45 s1_n_block (24 -> 1G)
at /users/Zijian/Disagg-mlir/tools/disagg/example/dataframe/cache_gen.py
change line 2 same

------------< not used
# at /users/Zijian/Disagg-mlir/tools/disagg/example/dataframe/allstep
cgeist -S -std=c++14 /users/Zijian/new_rt/apps/dataframe/new_app/all_step.cc -I /users/Zijian/new_rt/apps/dataframe/include -I /users/Zijian/new_rt/libcommon/include -o allstep.mlir
# after annotation
~/Disagg-mlir/tools/disagg/build/bin/pldisagg --prop-rmem allstep_anno.mlir -o target.mlir
~/Disagg-mlir/tools/disagg/build/bin/pldisagg --convert-target-to-remote target.mlir -o remote.mlir
------------>

# prefetch and batch
# skip if 1G: set dist = 0
# if error prompt: blabla does not dominate this, try several times (no idea why)
~/Disagg-mlir/tools/disagg/build/bin/pldisagg remote.mlir --rmem-loop-normal-cache="ccfg=/users/Zijian/Disagg-mlir/tools/disagg/example/dataframe/cache.cfg dist=8" -cse --canonicalize -o pref.mlir

~/Disagg-mlir/tools/disagg/build/bin/pldisagg --emit-llvm="ccfg=/users/Zijian/Disagg-mlir/tools/disagg/example/dataframe/cache.cfg" -reconcile-unrealized-casts -cse --canonicalize -cse pref.mlir -o lower.mlir
mlir-translate --mlir-to-llvmir lower.mlir -o lower.ll
clang-16 -c -O3 lower.ll -o lower.o

# to /users/Zijian/new_rt/build
make allstep_mlir
