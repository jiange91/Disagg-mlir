# At onnx-mlir
onnx-mlir-opt --affine-simplify-structures --convert-krnl-glob-to-alloc="omit-entry-point=true" -cse --canonicalize gpt2.onnx.mlir -o gpt2.alloc.mlir 

# At MLIR
after annotating gpt2.alloc.mlir -> target.mlir

pldisagg --prop-rmem target.mlir -o prop.mlir
pldisagg --convert-target-to-remote -cse -canonicalize prop.mlir -o remote.mlir
pldisagg --rmem-affine-access-mem="dist=1" --canonicalize --cse remote.mlir -o pools.mlir
pldisagg --rmem-affine-ring-cache -cse --canonicalize pools.mlir -o ring.mlir 
pldisagg ring.mlir --lower-rmem-in-func -emit-llvm --reconcile-unrealized-casts -cse --canonicalize -o lower.mlir
mlir-translate --mlir-to-llvmir lower.mlir -o lower.ll
clang-16 -O3 -c lower.ll -o lower_remote.o

# At runtime
make gpt2-remote
mv bin/gpt2-remote ../apps/bench-gpt2/model_onnx/


# Full local
# onnx-mlir-opt --affine-simplify-structures --convert-krnl-glob-to-alloc="omit-entry-point=true" -cse --canonicalize gpt2.onnx.mlir -o /users/Zijian/Disagg-mlir/tools/disagg/example/gpt2/medium/ae/gpt2.alloc.mlir 
# at /users/Zijian/Disagg-mlir/tools/disagg/example/gpt2/medium/ae
pldisagg gpt2.alloc.mlir -emit-llvm --reconcile-unrealized-casts -cse --canonicalize -o lower_local.mlir
mlir-translate --mlir-to-llvmir lower_local.mlir -o lower_local.ll
clang-16 -O3 -c lower_local.ll -o lower_local.o
# path: /users/Zijian/raw_eth_pktgen/build
make gpt2-local
mv bin/gpt2-local ../apps/bench-gpt2/model_onnx/
# at ../apps/bench-gpt2/model_onnx
./gpt2-local
