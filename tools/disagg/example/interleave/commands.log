# DO ONCE: at /users/Zijian/Disagg-mlir/tools/disagg/example/interleave
pldisagg --prop-rmem mlir/visit_anno.mlir -o mlir/target.mlir
pldisagg --convert-target-to-remote mlir/target.mlir -o mlir/remote.mlir

# EVERY TIME config changes
# change config at /users/Zijian/new_rt/apps/bench-interleave-mlir/remote.cc
# change /users/Zijian/Disagg-mlir/tools/disagg/example/interleave/cache.cfg accordingly

# change dist = 0 if not prefetch & not batch
# comment out line 465-466 in /users/Zijian/Disagg-mlir/tools/disagg/lib/Dialect/Transforms/LoopNormalCache.cpp, then dist = 0 will do batch but no prefetch
pldisagg mlir/remote.mlir --rmem-loop-normal-cache="ccfg=/users/Zijian/Disagg-mlir/tools/disagg/example/interleave/cache.cfg dist=11" -cse --canonicalize -o mlir/pref.mlir

pldisagg mlir/pref.mlir --emit-llvm="ccfg=/users/Zijian/Disagg-mlir/tools/disagg/example/interleave/cache.cfg" -reconcile-unrealized-casts -cse --canonicalize -cse -o mlir/lower_remote.mlir
mlir-translate --mlir-to-llvmir mlir/lower_remote.mlir -o mlir/lower.ll
clang-16 -O3 -c mlir/lower.ll -o mlir/lower.o

# at /users/Zijian/new_rt/build
make interlf-mlir-remote